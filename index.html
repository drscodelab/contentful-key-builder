<!doctype html>
<head>
  <link href="https://static.contentful.com/app/main-62e0abc7.css" media="all" rel="stylesheet" type="text/css">
  <link href="https://static.contentful.com/app/vendor-976872d7.css" media="all" rel="stylesheet" type="text/css">
  <link href="https://contentful.github.io/ui-extensions-sdk/cf-extension.css" media="all" rel="stylesheet" type="text/css">
  <script type="text/javascript" src="https://unpkg.com/contentful-ui-extensions-sdk@3"></script>
</head>
<div class="widget-key-editor">
  <input id="key" type="text" class="form-control" style="width: 98%; font-size: 14px">
  <i id="error" class="fa fa-exclamation-triangle is-key-duplicate"></i>
  <i id="ok" class="fa fa-check-circle is-key-unique"></i>
  <i id="loading" class="fa fa-spinner fa-spin"></i>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/es6-promise/3.0.2/es6-promise.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/3.10.1/lodash.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/speakingurl/7.0.0/speakingurl.min.js"></script>

<script>
var cfExt = window.contentfulExtension || window.contentfulWidget;

cfExt.init(function (api) {
  var keyField = api.field;
  var productField = api.entry.fields.product;
  var colorField = api.entry.fields.color;
  var designField = api.entry.fields.design;

  console.log('API', api);

  var _ = window._;
  var getKey = window.getKey;
  var debouncedUpdateStatus = _.debounce(updateStatus, 500);

  var input = document.getElementById('key');
  var statusElements = {
    error: document.getElementById('error'),
    ok: document.getElementById('ok'),
    loading: document.getElementById('loading'),
  };

  api.window.updateHeight();

  productField.onValueChanged(handleKeyChange);
  colorField.onValueChanged(handleKeyChange);
  designField.onValueChanged(handleKeyChange);

  input.addEventListener('input', function () {
    handleKeyChange(input.value);
  });
  input.addEventListener('change', function () {
    handleKeyChange(input.value);
  });

  updateStatus(keyField.getValue());

  /**
   * Handle change of key value caused by either changing key field
   * or changing the title of the entry
   */
  function handleKeyChange (value) {
    setKey(getKey(value || ''));
  }

  /**
   * Set the input value to 'key' and update the status by checking for
   * duplicates.
   */
  function setKey (key) {
    input.value = key;
    keyField.setValue(key);
    setStatus('loading');
    debouncedUpdateStatus(key);
  }

  /**
   * Show inline status icon based on current status
   */
  function updateStatus (key) {
    getDuplicates(key).then(function (hasDuplicates) {
      if (hasDuplicates) {
        setStatus('error');
      } else {
        setStatus('ok');
      }
    });
  }

  /**
   * Show icon for given status
   */
  function setStatus (status) {
    _.each(statusElements, function (el, name) {
      if (name === status) {
        el.style.display = 'inline';
      } else {
        el.style.display = 'none';
      }
    })
  }


  /**
   * Check if key is already in use.
   * Resolves to 'true' if there are entries of the given content type that have
   * the same 'key' value.
   */
  function getDuplicates (key) {
    if (!key) {
      return Promise.resolve(false);
    }

    var query = {};

    query['content_type'] = api.entry.getSys().contentType.sys.id;
    query['fields.' + keyField.id] = key;
    query['sys.id[ne]'] = api.entry.getSys().id;
    query['sys.publishedAt[exists]'] = true;

    return api.space.getEntries(query).then(function (result) {
      return result.total > 0;
    });
  }
});
</script>
